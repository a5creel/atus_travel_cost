---
title: "Summary Statistics"
author: "Andie Creel"
date: "2023-06-26"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message  = FALSE)

rm(list = ls())
options(scipen = 999)
library(dplyr)
library(tidyr)
library(stringr)
library(vroom)
library(mlogit)
library(stargazer)
library(lubridate)
library(choroplethr)
library(choroplethrMaps)
data("county.regions")
library(ipumsr)


```

## How ofter each activity is choosen

Assuming each choice occasion is a day, and you can choose at home leisure, away leisure, at home recreation, away recreation, or no leisure. Choices have been multiplied by their sampling weight.

```{r}
# -----------------------------------------------------------------------------
# read in R memory built in 05.R_data_objs
# -----------------------------------------------------------------------------
load("05.RUM_data_objs.RData")

# -----------------------------------------------------------------------------
# Read in data 
# -----------------------------------------------------------------------------

# need replication weights 
myWts <- vroom("clean_data/2.demographics_ALL.csv") %>%
  mutate(wt = wt06) %>%
  mutate(wt = if_else(year == 2020, wt20, wt06)) %>%
  select(caseid, year, wt)

myWorking_og <- vroom("clean_data/4.weather_tc_ALL.csv") 

myWorking <- myWorking_og %>%
  mutate(choice = if_else(number_activities > 0, 1, 0)) %>% # switching to extensive margin 
  left_join(myWts, by = c("year", "caseid")) %>% # merge in weights 
  mutate(choice_wt = choice*wt) # weighted

# -----------------------------------------------------------------------------
# How often does someone choose each thing (weights accounted for )
# -----------------------------------------------------------------------------

# function that takes as df and returns % of days of each activity is choosen 
getPercTable <- function(df){

  # divided by 5 because it's long by the 5 activities, multiplied by weight 
  n <- sum(df$wt) /5
  
  sumTable <- data.frame(activity = c("leisure_home", "leisure_away", "recreation_away", "recreation_home", "no_leisure", "obs"), percent_days_choosen = NA)
  
  sumTable$percent_days_choosen[1] <- as.numeric(sum(df[df$variable == "leisure_home",]$choice_wt)/n)
  sumTable$percent_days_choosen[2] <- as.numeric(sum(df[df$variable == "leisure_away",]$choice_wt)/n)
  sumTable$percent_days_choosen[3] <- as.numeric(sum(df[df$variable == "rec_home",]$choice_wt)/n)
  sumTable$percent_days_choosen[4] <- as.numeric(sum(df[df$variable == "rec_away",]$choice_wt)/n)
  sumTable$percent_days_choosen[5] <- as.numeric(sum(df[df$variable == "no_leisure",]$choice_wt)/n)
  sumTable$percent_days_choosen[6] <- nrow(df)/5
  
  sumTable <- sumTable %>% 
    mutate(percent_days_choosen = round(percent_days_choosen *100, 1)) 
  
  sumTable
}

getPercTable(myWorking)

```

## by season

```{r}
# -----------------------------------------------------------------------------
# Grouping by season 
# -----------------------------------------------------------------------------

# my season function 
seasonTables <- lapply(X = 1:4, function(x){
  myWorking %>%
    filter(quarter == x) %>%
    getPercTable() %>% 
    mutate(!!sym(paste0("quarter_", x)) := percent_days_choosen)%>%
    select(sym(paste0("quarter_", x)))})

bind_cols(activity = c("leisure_home", "leisure_away", "recreation_away", "recreation_home", "no_leisure", "obs"), 
          seasonTables)


```

## Comparing full sample to my sample with weather 

When I run the RUM model, I drop people who do "no leisure" because they're less than 1% of the population. 

Weather is an independent variable but only have if for half so comparing full set to set I use for RUM model. 

Most of the data is dropped due to missing weather, some is dropped due to not having income.

```{r}
# -----------------------------------------------------------------------------
# get some key averages
# -----------------------------------------------------------------------------

getKeyAvgs <- function(df){

  # full data set 
  sumTable <- data.frame(metric = c("income", "% white", "min travel for leisure away", "min travl for rec away", "n"),
                         average = NA)
  
  mySum_df_leisure <- df %>%
    select(caseid, year, fam_inc_mid, travel_time_total_state, variable, race) %>%
    filter(variable == "leisure_away") %>%
    distinct()
  
  mySum_df_rec <- df %>%
    select(caseid, year, fam_inc_mid, travel_time_total_state, variable, race) %>%
    filter(variable == "rec_away") %>%
    distinct()
  
  sumTable$average[1] <- mean(mySum_df_leisure$fam_inc_mid, na.rm = T)
  sumTable$average[2] <- as.numeric(round(sum(mySum_df_leisure$race == "white_noH") / nrow(mySum_df_leisure) *100, 1))
  sumTable$average[3] <- mean(mySum_df_leisure$travel_time_total_state)
  sumTable$average[4] <- mean(mySum_df_rec$travel_time_total_state)
  sumTable$average[5] <- as.integer(nrow(mySum_df_leisure))
  
  sumTable
}

df_1 <-  myWorking %>%
  filter(variable != "no_leisure") %>%
  getKeyAvgs() %>%
  mutate(average_full_dataset = average) %>%
  select(average_full_dataset)

df_2 <- getKeyAvgs(myRUM_df) %>%
  mutate(average_RUM_dataset = average) %>%
  select(average_RUM_dataset)

bind_cols(metric = c("income", "% white", "min travel for leisure away", "min travl for rec away", "n"), df_1, df_2)

```

## Map of counties I have data for

```{r}
myCounties <- myRUM_df %>%
  select(county) %>%
  distinct() %>%
  mutate(value = 1)

myCounties_map <- left_join(county.regions, myCounties, by = c("region" = "county")) %>%
  mutate(value = if_else(is.na(value), 0, value))

# county_choropleth(myCounties_map)

# WAITING UNTIL CHOROPLETH IS UPDATED.


```


## Average minutes doing activity 

```{r}
# -----------------------------------------------------------------------------
# Where I got the caluation for average take spent recreating per day
# In zotero: “American Time Use Survey User’s Guide,” 2022, 125.
# -----------------------------------------------------------------------------

get_avg_rec_min <- function(df){
  sum(df$sample_weight*df$total_min_rec)/sum(df$sample_weight)
}

# -----------------------------------------------------------------------------
# read in data
# -----------------------------------------------------------------------------

myData_og <- vroom("clean_data/2.ATUS_wide_og.csv")
myDems <- vroom("clean_data/2.demographics_ALL.csv")


myData <- myData_og %>%
  group_by(DATE, CASEID) %>%
  mutate(total_rec_away = sum(time_recreating_away_temp, na.rm = T)) %>%
  mutate(total_rec_home = sum(time_recreating_home_temp, na.rm = T)) %>%
  mutate(total_leisure_home = sum(time_leisure_home_temp, na.rm = T)) %>%
  mutate(total_leisure_away = sum(time_leisure_away_temp, na.rm = T)) %>%
  select(YEAR, CASEID, DATE, starts_with("total"), WT06, WT20) %>%
  distinct() %>%
  mutate(WT = if_else(YEAR != 2020, WT06, WT20)) %>%
  select(-WT06, -WT20)     

myData_next <- myData %>%
  group_by(YEAR) %>%
  mutate(mean_rec_away = sum(WT*total_rec_away)/sum(WT)) %>%
  mutate(mean_rec_home = sum(WT*total_rec_home)/sum(WT)) %>%
  mutate(mean_leisure_away = sum(WT*total_leisure_away)/sum(WT)) %>%
  mutate(mean_leisure_home = sum(WT*total_leisure_home)/sum(WT)) %>%
  select(YEAR, mean_rec_away, mean_rec_home, mean_leisure_away, mean_leisure_home) %>%
  distinct()
           



```








# next steps 

- map of counties who I have data for 
- avg by race 
- avg minutes doing each activity through years 
- show through season too 




