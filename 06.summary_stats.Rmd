---
title: "Summary Statistics"
author: "Andie Creel"
date: "2023-06-26"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message  = FALSE)

rm(list = ls())
options(scipen = 999)
library(dplyr)
library(tidyr)
library(stringr)
library(vroom)
library(mlogit)
library(stargazer)
library(lubridate)
library(choroplethr)
library(choroplethrMaps)
data("county.regions")
# library(R6)
# source("06.functions.R") #https://github.com/arilamstein/choroplethr/blob/master/R/usa.R#L24
library(ggplot2)
library(gridExtra)
```

# How ofter each activity is choosen

Assuming each choice occasion is a day, and you can choose at home leisure, away leisure, at home recreation, away recreation, or no leisure. Choices have been multiplied by their sampling weight.

```{r}
# -----------------------------------------------------------------------------
# read in R memory built in 05.R_data_objs
# -----------------------------------------------------------------------------
load("05.RUM_data_objs.RData")

# -----------------------------------------------------------------------------
# Read in data 
# -----------------------------------------------------------------------------

# need replication weights 
myWts <- vroom("clean_data/2.demographics_ALL.csv") %>%
  mutate(wt = wt06) %>%
  mutate(wt = if_else(year == 2020, wt20, wt06)) %>%
  select(caseid, year, wt)

myWorking_og <- vroom("clean_data/4.weather_tc_ALL.csv") 

myWorking <- myWorking_og %>%
  mutate(choice = if_else(number_activities > 0, 1, 0)) %>% # switching to extensive margin 
  left_join(myWts, by = c("year", "caseid")) %>% # merge in weights 
  mutate(choice_wt = choice*wt) # weighted

# -----------------------------------------------------------------------------
# How often does someone choose each thing (weights accounted for )
# -----------------------------------------------------------------------------

# function that takes as df and returns % of days of each activity is choosen 
getPercTable <- function(df){

  # divided by 5 because it's long by the 5 activities, multiplied by weight 
  n <- sum(df$wt) /5
  
  sumTable <- data.frame(activity = c("leisure_home", "leisure_away", "recreation_away", "recreation_home", "no_leisure", "obs"), percent_days_choosen = NA)
  
  sumTable$percent_days_choosen[1] <- as.numeric(sum(df[df$variable == "leisure_home",]$choice_wt)/n)
  sumTable$percent_days_choosen[2] <- as.numeric(sum(df[df$variable == "leisure_away",]$choice_wt)/n)
  sumTable$percent_days_choosen[3] <- as.numeric(sum(df[df$variable == "rec_home",]$choice_wt)/n)
  sumTable$percent_days_choosen[4] <- as.numeric(sum(df[df$variable == "rec_away",]$choice_wt)/n)
  sumTable$percent_days_choosen[5] <- as.numeric(sum(df[df$variable == "no_leisure",]$choice_wt)/n)
  sumTable$percent_days_choosen[6] <- nrow(df)/5
  
  sumTable <- sumTable %>% 
    mutate(percent_days_choosen = round(percent_days_choosen *100, 1)) 
  
  sumTable
}

getPercTable(myWorking)

```

## by season

```{r}
# -----------------------------------------------------------------------------
# Grouping by season 
# -----------------------------------------------------------------------------

# my season function 
seasonTables <- lapply(X = 1:4, function(x){
  myWorking %>%
    filter(quarter == x) %>%
    getPercTable() %>% 
    mutate(!!sym(paste0("quarter_", x)) := percent_days_choosen)%>%
    select(sym(paste0("quarter_", x)))})

bind_cols(activity = c("leisure_home", "leisure_away", "recreation_away", "recreation_home", "no_leisure", "obs"), 
          seasonTables)


```

# Comparing full sample to my sample with weather 

When I run the RUM model, I drop people who do "no leisure" because they're less than 1% of the population. 

ATTN: Weather is an independent variable but only have if for half so comparing full set to set I use for RUM model. I need to see if I can merge county weather on MSA's, I think that's why I'm loosing so many observations. 

Most of the data is dropped due to missing weather, some is dropped due to not having income.

```{r}
# -----------------------------------------------------------------------------
# get some key averages
# -----------------------------------------------------------------------------

getKeyAvgs <- function(df){

  # full data set 
  sumTable <- data.frame(metric = c("income", "% white", "min travel for leisure away", "min travl for rec away", "n"),
                         average = NA)
  
  mySum_df_leisure <- df %>%
    select(caseid, year, fam_inc_mid, travel_time_total_state, variable, race) %>%
    filter(variable == "leisure_away") %>%
    distinct()
  
  mySum_df_rec <- df %>%
    select(caseid, year, fam_inc_mid, travel_time_total_state, variable, race) %>%
    filter(variable == "rec_away") %>%
    distinct()
  
  sumTable$average[1] <- mean(mySum_df_leisure$fam_inc_mid, na.rm = T)
  sumTable$average[2] <- as.numeric(round(sum(mySum_df_leisure$race == "white_noH") / nrow(mySum_df_leisure) *100, 1))
  sumTable$average[3] <- mean(mySum_df_leisure$travel_time_total_state)
  sumTable$average[4] <- mean(mySum_df_rec$travel_time_total_state)
  sumTable$average[5] <- as.integer(nrow(mySum_df_leisure))
  
  sumTable
}

df_1 <-  myWorking %>%
  filter(variable != "no_leisure") %>%
  getKeyAvgs() %>%
  mutate(average_full_dataset = average) %>%
  select(average_full_dataset)

df_2 <- getKeyAvgs(myRUM_df) %>%
  mutate(average_RUM_dataset = average) %>%
  select(average_RUM_dataset)

bind_cols(metric = c("income", "% white", "min travel for leisure away", "min travl for rec away", "n"), df_1, df_2)

```

Seems like currently I'm dropping white poor people (which makes me think I'm dropping rural people). 


# Map of counties I have data for

Unfortunately the choropleth package isn't compatable with the newest verison of R so I'm waiting for it to be updated to do this. 

```{r, eval=FALSE}
myCounties <- myRUM_df %>%
  select(county) %>%
  distinct() %>%
  mutate(value = 1)

myCounties_map <- left_join(county.regions, myCounties, by = c("region" = "county")) %>%
  mutate(value = if_else(is.na(value), 0, value))

# myCounty_choropleth(myCounties_map)

# WAITING UNTIL CHOROPLETH IS UPDATED.


```


# Avg min doing activity 

```{r}
# -----------------------------------------------------------------------------
# read in data
# -----------------------------------------------------------------------------

myData_og <- vroom("clean_data/2.ATUS_wide_og.csv")
myDems <- vroom("clean_data/3.demographics_cleaned.csv")

myData <- myData_og %>%
  group_by(date, caseid) %>%
  mutate(total_rec_away = sum(time_recreating_away_temp, na.rm = T)) %>%
  mutate(total_rec_home = sum(time_recreating_home_temp, na.rm = T)) %>%
  mutate(total_leisure_home = sum(time_leisure_home_temp, na.rm = T)) %>%
  mutate(total_leisure_away = sum(time_leisure_away_temp, na.rm = T)) %>%
  select(year, caseid, date, starts_with("total"), wt06, wt20) %>%
  distinct() %>%
  mutate(wt = if_else(year != 2020, wt06, wt20)) %>%
  select(-wt06, -wt20)     


# -----------------------------------------------------------------------------
# Calculating average time per year
# In zotero: “American Time Use Survey User’s Guide,” 2022, 125.
# -----------------------------------------------------------------------------

myData_graphs <- myData %>%
  group_by(year) %>%
  mutate(rec_away = sum(wt*total_rec_away)/sum(wt)) %>%
  mutate(rec_home = sum(wt*total_rec_home)/sum(wt)) %>%
  mutate(leisure_away = sum(wt*total_leisure_away)/sum(wt)) %>%
  mutate(leisure_home = sum(wt*total_leisure_home)/sum(wt)) %>%
  select(year, 
         rec_away, rec_home,
         leisure_away, leisure_home
         ) %>%
  distinct()
           
myGraph_long <- myData_graphs %>%
  pivot_longer(
    cols = c(rec_away,rec_home, leisure_away,  leisure_home), # Select the columns to pivot
    names_to = "activity",       # Name of the new 'variable' column
    values_to = "minutes"          # Name of the new 'value' column
  )


# -----------------------------------------------------------------------------
# Leisure graph
# -----------------------------------------------------------------------------
myGraph_leisure <- myGraph_long %>%
  filter(str_detect(activity, "^leisure"))

# Plotting the data using ggplot
plot_leisure_1 <- ggplot(myGraph_leisure, aes(x = year, y = minutes, color = activity)) +
  geom_line() +
  labs(x = "Year", y = "Minutes") +
  scale_color_discrete(name = "activity") +
  ggtitle("Avg min on leisure per day") +
  theme_bw()


```
 

```{r}
# -----------------------------------------------------------------------------
# Recreations graph
# -----------------------------------------------------------------------------
myGraph_rec <- myGraph_long %>%
  filter(str_detect(activity, "^rec"))

# Plotting the data using ggplot
plot_rec_1 <- ggplot(myGraph_rec, aes(x = year, y = minutes, color = activity)) +
  geom_line() +
  labs(x = "Year", y = "Minutes") +
  scale_color_discrete(name = "activity") +
  ggtitle("Avg min on recreation per day") +
  theme_bw()


```





```{r}
# -----------------------------------------------------------------------------
# creating cyclical maps
# -----------------------------------------------------------------------------

myData_seasons <- myData_og %>%
  mutate(year_q = year+(quarter-1)*.25) %>%
  group_by(date, caseid) %>%
  mutate(total_rec_away = sum(time_recreating_away_temp, na.rm = T)) %>%
  mutate(total_rec_home = sum(time_recreating_home_temp, na.rm = T)) %>%
  mutate(total_leisure_home = sum(time_leisure_home_temp, na.rm = T)) %>%
  mutate(total_leisure_away = sum(time_leisure_away_temp, na.rm = T)) %>%
  select(year, caseid, date, starts_with("total"), wt06, wt20, year_q) %>%
  distinct() %>%
  mutate(wt = if_else(year != 2020, wt06, wt20)) %>%
  select(-wt06, -wt20) %>%   
  group_by(year_q) %>%
  mutate(rec_away = sum(wt*total_rec_away)/sum(wt)) %>%
  mutate(rec_home = sum(wt*total_rec_home)/sum(wt)) %>%
  mutate(leisure_away = sum(wt*total_leisure_away)/sum(wt)) %>%
  mutate(leisure_home = sum(wt*total_leisure_home)/sum(wt)) %>%
  select(year, year_q,
         rec_away, rec_home,
         leisure_away, leisure_home
         ) %>%
  distinct()

mySeasons_long <- myData_seasons %>%
  pivot_longer(
    cols = c(rec_away,rec_home, leisure_away,  leisure_home), # Select the columns to pivot
    names_to = "activity",      
    values_to = "minutes"          
  )

# -----------------------------------------------------------------------------
# Leisure graph
# -----------------------------------------------------------------------------
mySeasons_leisure <- mySeasons_long %>%
  filter(str_detect(activity, "^leisure"))

# Plotting the data using ggplot
plot_leisure_2 <- ggplot(mySeasons_leisure, aes(x = year_q, y = minutes, color = activity)) +
  geom_line() +
  labs(x = "Year", y = "Minutes") +
  scale_color_discrete(name = "activity") +
  ggtitle("Avg min on leisure per day") +
  theme_bw()



```



```{r}
# -----------------------------------------------------------------------------
# recreation graph
# -----------------------------------------------------------------------------
mySeasons_rec <- mySeasons_long %>%
  filter(str_detect(activity, "^rec"))

# Plotting the data using ggplot
plot_rec_2 <-  ggplot(mySeasons_rec, aes(x = year_q, y = minutes, color = activity)) +
  geom_line() +
  labs(x = "Year", y = "Minutes") +
  scale_color_discrete(name = "activity") +
  ggtitle("Avg min on recreation per day") +
  theme_bw()

grid.arrange(plot_leisure_1, plot_rec_1, plot_leisure_2, plot_rec_2, 
             nrow = 2, ncol = 2)

```

Both leisure activities have held steady over the study period, with the exception of during covid. Recreation is also fairly steady with potentially a spike during COVID. 

Cyclical trend on second row. Leisure away goes up in summer months and down in winter. Opposite is true for leisure at home. 

Way easier to see the cyclical trend with outdoor recreation.

# By race

```{r}
# -----------------------------------------------------------------------------
# what races am i including
# -----------------------------------------------------------------------------
myDems_race <- myDems %>%
  select(caseid, race) 

race_counts <- table(myDems_race$race)/nrow(myDems_race)

# Include: white_noH, black, hispanic (combined), asian, other

myDems_race <- myDems_race %>%
  mutate(race_1 = race) %>%
  mutate(race_1 = if_else(race == "hispanic_black" | race == "hispanic_white", 
         "hispanic", race_1)) %>%
  mutate(race_1 = if_else(race == "islander" | race == "native" | race == "other" | race == "white-asian" | race == "white-black" | race == "white-native", 
         "other", race_1)) 

race_counts <- table(myDems_race$race_1)/nrow(myDems_race)

```


```{r}

myRace <- left_join(myData, myDems_race, by = "caseid")

myRace_graphs <- myRace %>%
  group_by(year, race_1) %>%
  mutate(rec_away = sum(wt*total_rec_away)/sum(wt)) %>%
  mutate(rec_home = sum(wt*total_rec_home)/sum(wt)) %>%
  mutate(leisure_away = sum(wt*total_leisure_away)/sum(wt)) %>%
  mutate(leisure_home = sum(wt*total_leisure_home)/sum(wt)) %>%
  select(year, 
         rec_away, rec_home,
         leisure_away, leisure_home,
         race_1) %>%
  distinct()
           
myRace_long <- myRace_graphs %>%
  pivot_longer(
    cols = c(rec_away, rec_home, leisure_away,  leisure_home), # Select the columns to pivot
    names_to = "activity",       # Name of the new 'variable' column
    values_to = "minutes"          # Name of the new 'value' column
  )


# -----------------------------------------------------------------------------
# Leisure home graph
# -----------------------------------------------------------------------------
myRace_leisure_home <- myRace_long %>%
  filter(str_detect(activity, "^leisure_home"))

# Plotting the data using ggplot
plot_race_1 <- ggplot(myRace_leisure_home, aes(x = year, y = minutes, color = race_1)) +
  geom_line() +
  labs(x = "Year", y = "Minutes") +
  scale_color_discrete(name = "race") +
  ggtitle("Avg min on leisure at home per day") +
  theme_bw()

# -----------------------------------------------------------------------------
# Leisure away graph
# -----------------------------------------------------------------------------
myRace_leisure_away <- myRace_long %>%
  filter(str_detect(activity, "^leisure_away"))

# Plotting the data using ggplot
plot_race_2 <-ggplot(myRace_leisure_away, aes(x = year, y = minutes, color = race_1)) +
  geom_line() +
  labs(x = "Year", y = "Minutes") +
  scale_color_discrete(name = "race") +
  ggtitle("Avg min on leisure away from home per day") +
  theme_bw()


```



```{r}
# -----------------------------------------------------------------------------
# rec home graph
# -----------------------------------------------------------------------------
myRace_rec_home <- myRace_long %>%
  filter(str_detect(activity, "^rec_home")) %>%
  filter(!str_detect(race_1, "^other"))

# Plotting the data using ggplot
plot_race_3 <-ggplot(myRace_rec_home, aes(x = year, y = minutes, color = race_1)) +
  geom_line() +
  labs(x = "Year", y = "Minutes") +
  scale_color_discrete(name = "race") +
  ggtitle("Avg min on recreation at home per day") +
  theme_bw()

# -----------------------------------------------------------------------------
# Leisure away graph
# -----------------------------------------------------------------------------
myRace_rec_away <- myRace_long %>%
  filter(str_detect(activity, "^rec_away"))%>%
  filter(!str_detect(race_1, "^other"))

# Plotting the data using ggplot
plot_race_4 <-ggplot(myRace_rec_away, aes(x = year, y = minutes, color = race_1)) +
  geom_line() +
  labs(x = "Year", y = "Minutes") +
  scale_color_discrete(name = "race") +
  ggtitle("Avg min on recreation away from home per day") +
  theme_bw()


grid.arrange(plot_race_1, plot_race_2, plot_race_3, plot_race_4, nrow = 2, ncol = 2)
```



Black people participate in much more leisure at home. 


Black and Asian people do less recreation at home, and black people participate in much less recreation in general. 

# next steps 

- map of counties who I have data for (waiting for choropleth to be updated)





